Big Malachite Dinosaur

Medium

# Rewards distribution duration can be doubled and rate almost halved because of constant reset duration attack

### Summary

There is a vulnerability in `_addRewardsForToken` where we can prolong the duration to distribute `x` amount of rewards and in the process distribute less rewards as well.

By default `notifyRewardAmount` updates pending rewards, and then with the new deposited reward amount, starts a  new period.

This new period will have the default duration and the `amount + added_rewards` as its total amount.
Rate is computed as amount / duration.

However this can be exploited by depositing negligible small amounts that just prolong the distribution, affecting the rate as well since it can be made smaller and smaller by just increasing the duration.


### Root Cause

https://github.com/sherlock-audit/2025-03-symm-io-stacking/blob/main/token/contracts/staking/SymmStaking.sol#L377-L378

We see that the Auction's `periodFinish` can be updated constantly to affect the rate by depositing small amounts such that duration is increased but amounts not significantly increased.

```solidity
		if (block.timestamp >= state.periodFinish) {
			state.rate = amount / state.duration;
		} else {
@>			uint256 remaining = state.periodFinish - block.timestamp;
@>			uint256 leftover = remaining * state.rate;
@>			state.rate = (amount + leftover) / state.duration;
		}
```

### Internal Pre-conditions

1.

### External Pre-conditions

1.

### Attack Path

1. Admin calls notify reward for 300 tokens (with decimals) say for 30 days
2. Rate amount is distributed which would be about ~ 10 tokens
3. Attacker calls notify reward at end of day, so new rate is 290 + (negligible amount ) / 30 (same duration)
4. only 9.66 is distributed (rate is lower) , attacker calls again ~ new rate is 280.33/30
5. This continues till rate withers and duration is extended a lot


### Impact

The protocol suffers time delays in reward and potential loss of rewards to users because of rounding as well

### PoC

example demonstrating the adjusted rate with example numbers numerically 
```javascript

~ day, rate and the amount left to distribute.

r 0 : 10.0 : 300
r 1 : 9.666666666666666 : 290.0
r 2 : 9.344444444444443 : 280.3333333333333
r 3 : 9.032962962962962 : 270.9888888888889
r 4 : 8.731864197530863 : 261.9559259259259
r 5 : 8.440802057613167 : 253.22406172839504
r 6 : 8.159441989026062 : 244.7832596707819
r 7 : 7.8874605893918615 : 236.62381768175584
r 8 : 7.624545236412133 : 228.736357092364
r 9 : 7.370393728531728 : 221.11181185595186
r 10 : 7.124713937580671 : 213.74141812742013
r 11 : 6.887223472994648 : 206.61670418983945
r 12 : 6.657649357228161 : 199.72948071684482
r 13 : 6.435727711987222 : 193.07183135961665
r 14 : 6.221203454920981 : 186.63610364762943
r 15 : 6.013830006423615 : 180.41490019270844
r 16 : 5.813369006209495 : 174.40107018628484
r 17 : 5.619590039335845 : 168.58770118007536
r 18 : 5.432270371357984 : 162.96811114073952
r 19 : 5.251194692312718 : 157.53584076938154
r 20 : 5.076154869235627 : 152.28464607706883
r 21 : 4.906949706927773 : 147.2084912078332
r 22 : 4.7433847166968475 : 142.30154150090542
r 23 : 4.5852718928069525 : 137.55815678420856
r 24 : 4.4324294963800535 : 132.9728848914016
r 25 : 4.284681846500718 : 128.54045539502155
r 26 : 4.141859118284028 : 124.25577354852084
r 27 : 4.00379714767456 : 120.1139144302368
r 28 : 3.8703372427520746 : 116.11011728256224
r 29 : 3.7413260013270055 : 112.23978003981017
r 30 : 3.6166151346161053 : 108.49845403848316
r 31 : 3.496061296795568 : 104.88183890386705
r 32 : 3.3795259202357157 : 101.38577760707147
r 33 : 3.2668750562278586 : 98.00625168683575
r 34 : 3.157979221020263 : 94.7393766306079
r 35 : 3.052713246986254 : 91.58139740958762
r 36 : 2.9509561387533787 : 88.52868416260137
r 37 : 2.852590934128266 : 85.57772802384798
r 38 : 2.7575045696573235 : 82.72513708971971
r 39 : 2.665587750668746 : 79.96763252006238
r 40 : 2.5767348256464544 : 77.30204476939363
r 41 : 2.4908436647915724 : 74.72530994374718
r 42 : 2.4078155426318535 : 72.23446627895561
r 43 : 2.327555024544125 : 69.82665073632376
r 44 : 2.249969857059321 : 67.49909571177963
r 45 : 2.17497086182401 : 65.2491258547203
r 46 : 2.1024718330965433 : 63.0741549928963
r 47 : 2.0323894386599917 : 60.97168315979975
r 48 : 1.964643124037992 : 58.93929372113976
r 49 : 1.8991550199033924 : 56.97465059710177
r 50 : 1.8358498525732794 : 55.07549557719838
r 51 : 1.7746548574875034 : 53.2396457246251
r 52 : 1.7154996955712531 : 51.464990867137594
r 53 : 1.6583163723855447 : 49.74949117156634
r 54 : 1.6030391599726932 : 48.0911747991808
r 55 : 1.5496045213069367 : 46.4881356392081
r 56 : 1.4979510372633722 : 44.938531117901164
r 57 : 1.4480193360212599 : 43.440580080637794
r 58 : 1.399752024820551 : 41.99256074461653
r 59 : 1.3530936239931994 : 40.59280871979598
r 60 : 1.3079905031934262 : 39.23971509580279
r 61 : 1.2643908197536455 : 37.93172459260936
r 62 : 1.2222444590951906 : 36.66733377285572
r 63 : 1.181502977125351 : 35.445089313760526
r 64 : 1.142119544554506 : 34.26358633663518
r 65 : 1.1040488930693557 : 33.121466792080675
r 66 : 1.0672472633003773 : 32.01741789901132
r 67 : 1.031672354523698 : 30.950170635710943
r 68 : 0.9972832760395748 : 29.918498281187244
r 69 : 0.9640405001715889 : 28.92121500514767
r 70 : 0.931905816832536 : 27.95717450497608
r 71 : 0.9008422896047849 : 27.025268688143544
r 72 : 0.8708142132846253 : 26.12442639853876
r 73 : 0.8417870728418044 : 25.253612185254134
r 74 : 0.8137275037470777 : 24.41182511241233
r 75 : 0.7866032536221751 : 23.598097608665253
r 76 : 0.7603831451681026 : 22.811494355043077
r 77 : 0.7350370403291658 : 22.051111209874975
r 78 : 0.7105358056515271 : 21.31607416954581
r 79 : 0.6868512787964761 : 20.605538363894283
r 80 : 0.6639562361699269 : 19.918687085097808
r 81 : 0.6418243616309294 : 19.25473084892788
r 82 : 0.6204302162432318 : 18.612906487296954
r 83 : 0.5997492090351241 : 17.99247627105372
r 84 : 0.5797575687339532 : 17.392727062018597
r 85 : 0.5604323164428214 : 16.812969493284644
r 86 : 0.5417512392280608 : 16.252537176841823
r 87 : 0.5236928645871254 : 15.710785937613762
r 88 : 0.5062364357675545 : 15.187093073026636
r 89 : 0.48936188790863605 : 14.680856637259081
r 90 : 0.4730498249783482 : 14.191494749350445
r 91 : 0.4572814974790699 : 13.718444924372097
r 92 : 0.4420387808964342 : 13.261163426893027
r 93 : 0.4273041548665531 : 12.819124645996594
r 94 : 0.413060683037668 : 12.39182049113004
r 95 : 0.39929199360307904 : 11.978759808092372
r 96 : 0.38598226048297646 : 11.579467814489293
r 97 : 0.3731161851335439 : 11.193485554006317
r 98 : 0.3606789789624258 : 10.820369368872774
r 99 : 0.3486563463303449 : 10.459690389910348


```



Normal rate comparison

```rust
r 0 : 10.0 : 300
r 1 : 10.0 : 290.0
r 2 : 10.0 : 280.0
r 3 : 10.0 : 270.0
r 4 : 10.0 : 260.0
r 5 : 10.0 : 250.0
r 6 : 10.0 : 240.0
r 7 : 10.0 : 230.0
r 8 : 10.0 : 220.0
r 9 : 10.0 : 210.0
r 10 : 10.0 : 200.0
r 11 : 10.0 : 190.0
r 12 : 10.0 : 180.0
r 13 : 10.0 : 170.0
r 14 : 10.0 : 160.0
r 15 : 10.0 : 150.0
r 16 : 10.0 : 140.0
r 17 : 10.0 : 130.0
r 18 : 10.0 : 120.0
r 19 : 10.0 : 110.0
r 20 : 10.0 : 100.0
r 21 : 10.0 : 90.0
r 22 : 10.0 : 80.0
r 23 : 10.0 : 70.0
r 24 : 10.0 : 60.0
r 25 : 10.0 : 50.0
r 26 : 10.0 : 40.0
r 27 : 10.0 : 30.0
r 28 : 10.0 : 20.0
r 29 : 10.0 : 10.0

```

### Mitigation

consider retaining same duration and period but adjusted rate

and reset only when period finishes

```diff
	function _addRewardsForToken(address token, uint256 amount) internal {
		TokenRewardState storage state = rewardState[token];

		if (block.timestamp >= state.periodFinish) {
			state.rate = amount / state.duration;
+            		state.lastUpdated = block.timestamp;
+		        state.periodFinish = block.timestamp + state.duration;
		} else {
			uint256 remaining = state.periodFinish - block.timestamp;
			uint256 leftover = remaining * state.rate;
-			state.rate = (amount + leftover) / state.duration;
+			state.rate = (amount + leftover) / remaining;
		}

-		state.lastUpdated = block.timestamp;
-		state.periodFinish = block.timestamp + state.duration;
	}
```